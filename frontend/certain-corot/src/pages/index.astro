---
export const prerender = false;

// 1. Define the variable from your .env file
// If the .env is missing, it falls back to 127.0.0.1:3000 as a safety net
const BACKEND_URL = import.meta.env.PUBLIC_PAYLOAD_URL || "http://127.0.0.1:3000";

const cookie = Astro.request.headers.get("cookie") || "";
let user = null;
let tasks = [];

try {
  // 2. Use backticks `` and ${BACKEND_URL} to replace the hardcoded string
  const meRes = await fetch(`${BACKEND_URL}/api/users/me`, {
    headers: { cookie },
  });

  if (meRes.ok) {
    const meData = await meRes.json();
    user = meData.user;
  }

  // 3. Do the same for the tasks fetch
  const taskRes = await fetch(`${BACKEND_URL}/api/tasks?limit=50&sort=-createdAt&depth=1`, {
    headers: { cookie },
  });

  if (taskRes.ok) {
    const taskData = await taskRes.json();
    tasks = taskData.docs || [];
  }
} catch (e) {
  console.log("FETCH FAILED:", e.message);
}
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Quick Tasks</title>
  </head>
  <body class="bg-gray-100 min-h-screen flex flex-col items-center p-10 text-black">
    <div class="w-full max-w-md bg-white p-6 rounded-lg shadow-md">
      <h1 class="text-2xl font-bold mb-4 text-gray-800 text-center">Quick Tasks</h1>

      {user ? (
        <div class="mb-6">
          <div class="flex justify-between items-center mb-4 bg-blue-50 p-2 rounded">
            <p class="text-xs text-blue-700 font-medium">Logged in: {user.email}</p>
            <button id="logout-btn" class="text-xs text-red-600 underline font-bold cursor-pointer">Logout</button>
          </div>

          <form id="task-form" class="flex flex-col gap-3 mb-8 p-4 bg-gray-50 rounded-lg border border-gray-200">
            <div class="flex gap-2">
              <input type="text" name="content" placeholder="Add a task..." class="flex-1 border p-2 rounded text-black" required />
              <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Add</button>
            </div>
            <input type="file" name="file" accept="image/*" class="text-xs" />
          </form>
        </div>
      ) : (
        <div class="mb-8 p-6 bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg text-center">
          <p class="text-gray-600 mb-4">Log in to create tasks.</p>
          <a href="/login" class="bg-blue-600 text-white px-6 py-2 rounded inline-block text-sm">Login</a>
        </div>
      )}

      <ul class="space-y-2">
        {tasks.map((task: any) => {
          const imageData = task.taskImage;
          const hasImage = imageData && typeof imageData === "object";
          return (
            <li class="flex items-center gap-4 p-3 border rounded bg-white">
              {hasImage && (
                <img src={`http://127.0.0.1:3000/api/media/file/${imageData.filename}`} class="w-10 h-10 object-cover rounded" />
              )}
              <span class="flex-1">{task.content}</span>
              <button data-id={task.id} class="delete-btn text-red-500 text-xl">üóëÔ∏è</button>
            </li>
          );
        })}
      </ul>
    </div>

    <script>
      // LOGOUT LOGIC
      const BACKEND_URL = import.meta.env.PUBLIC_PAYLOAD_URL || "http://127.0.0.1:3000";
      const logoutBtn = document.getElementById("logout-btn");
      if (logoutBtn) {
        logoutBtn.addEventListener("click", async () => {
          await fetch(`${BACKEND_URL}/api/users/logout`, { method: "POST", credentials: "include" });
          document.cookie = "payload-token=; Max-Age=0; path=/;";
          window.location.href = "/";
        });
      }

      // TASK FORM LOGIC
      const form = document.getElementById("task-form") as HTMLFormElement;
      if (form) {
        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = new FormData(form);
          const content = formData.get("content");
          const file = formData.get("file") as File;
          let imageId = null;

          if (file && file.size > 0) {
            const mediaData = new FormData();
            mediaData.append("file", file);
            const mRes = await fetch(`${BACKEND_URL}/api/media`, { method: "POST", body: mediaData, credentials: "include" });
            if (mRes.ok) { const mJson = await mRes.json(); imageId = mJson.doc.id; }
          }

          const tRes = await fetch(`${BACKEND_URL}/api/tasks`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ content, taskImage: imageId }),
            credentials: "include"
          });
          if (tRes.ok) window.location.reload();
        });
      }

      // DELETE LOGIC
      document.addEventListener("click", async (e) => {
        const btn = (e.target as HTMLElement).closest(".delete-btn");
        if (btn && confirm("Delete?")) {
          const id = btn.getAttribute("data-id");
          await fetch(`${BACKEND_URL}/api/tasks/${id}`, { method: "DELETE", credentials: "include" });
          window.location.reload();
        }
      });
    </script>
  </body>
</html>