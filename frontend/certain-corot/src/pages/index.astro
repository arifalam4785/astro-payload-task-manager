---
import Layout from "../layouts/Layout.astro";


export const prerender = false;

const BACKEND_URL = import.meta.env.PUBLIC_PAYLOAD_URL || "http://127.0.0.1:3000";
const cookie = Astro.request.headers.get("cookie") || "";

let user = null;
let tasks = [];

try {
  const meRes = await fetch(`${BACKEND_URL}/api/users/me`, {
    headers: { cookie },
  });

  if (meRes.ok) {
    const meData = await meRes.json();
    user = meData.user;
  }

  // Fetching with depth=1 so taskImage becomes an object with an ID and URL
  const taskRes = await fetch(`${BACKEND_URL}/api/tasks?limit=50&sort=-createdAt&depth=1`, {
    headers: { cookie },
  });

  if (taskRes.ok) {
    const taskData = await taskRes.json();
    tasks = taskData.docs || [];
  }
} catch (e) {
  console.log("FETCH FAILED:", e.message);
}
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Quick Tasks</title>
  </head>
  <body class="bg-gray-100 min-h-screen flex flex-col items-center p-10 text-black">
    <Layout title="Quick Tasks">
    <div class="w-full max-w-md bg-white p-6 rounded-lg shadow-md">
      <div class="flex justify-center items-center mb-4">
      <h1 class="text-2xl font-bold mb-4 text-gray-800 text-center">Quick Tasks</h1>

      </div>

      {user ? (
        <div class="mb-6">
          <div class="flex justify-between items-center mb-4 bg-blue-50 p-2 rounded">
            <p class="text-xs text-blue-700 font-medium">Logged in: {user.email}</p>
            <button id="logout-btn" class="text-xs text-red-600 underline font-bold cursor-pointer">Logout</button>
          </div>

          <form id="task-form" class="flex flex-col gap-3 mb-8 p-4 bg-gray-50 rounded-lg border border-gray-200">
            <div class="flex gap-2">
              <input type="text" name="content" placeholder="Add a task (e.g. My Blog)..." class="flex-1 border p-2 rounded text-black" required />
              <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded font-bold hover:bg-blue-700">Add</button>
            </div>
            <input type="file" name="file" accept="image/*,.html" class="text-xs" />
          </form>
        </div>
      ) : (
        <div class="mb-8 p-6 bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg text-center">
          <p class="text-gray-600 mb-4">Log in to create tasks.</p>
          <a href="/login" class="bg-blue-600 text-white px-6 py-2 rounded inline-block text-sm">Login</a>
        </div>
      )}

      <ul class="space-y-3">
        {tasks.map((task: any) => {
          const imageData = task.taskImage;
          const isHtml = imageData?.mimeType === 'text/html';
          const isImage = imageData?.mimeType?.includes('image');

          return (
            <li class="flex items-center justify-between p-3 border rounded bg-white hover:bg-gray-50 transition shadow-sm">
              <div class="flex items-center gap-4">
                {/* 1. Show Image Preview or HTML Icon */}
                {isImage && (
                  <img src={imageData.url} class="w-10 h-10 object-cover rounded shadow-sm" />
                )}
                {isHtml && (
                  <div class="w-10 h-10 bg-green-100 flex items-center justify-center rounded text-xl shadow-sm">
                    üìÑ
                  </div>
                )}

                <div class="flex flex-col">
                  <a href={`/task/${task.id}`} class="font-medium text-gray-800 hover:text-blue-600">{task.content}</a>
                  
                  {/* 2. DYNAMIC LINK: Automatically uses the media ID from Payload */}
                  {isHtml && (
                    <a 
                      href={`/render/${imageData.id}`} 
                      target="_blank" 
                      class="text-xs text-blue-600 font-bold hover:underline flex items-center gap-1 mt-1"
                    >
                      üëÅÔ∏è VIEW LIVE BLOG
                    </a>
                  )}
                </div>
              </div>
              
              <button data-id={task.id} class="delete-btn text-gray-400 hover:text-red-500 transition text-xl px-2">
                üóëÔ∏è
              </button>
            </li>
          );
        })}
      </ul>
    </div>
    </Layout>

    <script>
      const BACKEND_URL = import.meta.env.PUBLIC_PAYLOAD_URL || "http://127.0.0.1:3000";

      // LOGOUT
      const logoutBtn = document.getElementById("logout-btn");
      if (logoutBtn) {
        logoutBtn.addEventListener("click", async () => {
          try {
            await fetch(`${BACKEND_URL}/api/users/logout`, { method: "POST", credentials: "include" });
            document.cookie = "payload-token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
            window.location.replace("/login"); 
          } catch (err) {
            console.error("Logout failed", err);
          }
        });
      }

      // TASK FORM (UPLOADS AND LINKS AUTOMATICALLY)
      const form = document.getElementById("task-form") as HTMLFormElement;
      if (form) {
        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement;
          submitBtn.disabled = true;
          submitBtn.innerText = "...";

          const formData = new FormData(form);
          const content = formData.get("content");
          const file = formData.get("file") as File;
          let imageId = null;

          try {
            if (file && file.size > 0) {
              const mediaData = new FormData();
              mediaData.append("file", file);
              const mRes = await fetch(`${BACKEND_URL}/api/media`, { method: "POST", body: mediaData, credentials: "include" });
              if (mRes.ok) { 
                const mJson = await mRes.json(); 
                imageId = mJson.doc.id; // This ID is what makes the link dynamic!
              }
            }

            const tRes = await fetch(`${BACKEND_URL}/api/tasks`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ content, taskImage: imageId }),
              credentials: "include"
            });
            
            if (tRes.ok) window.location.reload();
          } catch (err) {
            console.error(err);
          } finally {
            submitBtn.disabled = false;
            submitBtn.innerText = "Add";
          }
        });
      }

      // DELETE
      document.addEventListener("click", async (e) => {
        const btn = (e.target as HTMLElement).closest(".delete-btn");
        if (btn && confirm("Delete task?")) {
          const id = btn.getAttribute("data-id");
          const res = await fetch(`${BACKEND_URL}/api/tasks/${id}`, { method: "DELETE", credentials: "include" });
          if (res.ok) window.location.reload();
        }
      });
    </script>
  </body>
</html>